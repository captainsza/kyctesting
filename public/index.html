<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aadhar OTP Verification</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1>Aadhar KYC Verification</h1>
        <div id="connection-status" class="status-bar">Checking API connection...</div>

        <!-- Send OTP Form -->
        <div class="form-section">
            <h2>Step 1: Send OTP</h2>
            <label for="sendAadhar">Aadhar Number:</label>
            <input type="text" id="sendAadhar" placeholder="Enter 12-digit Aadhar Number" maxlength="12">
            <button id="sendOtpBtn" onclick="sendOTP()">Send OTP</button>
            <div id="sendLoading" class="loading" style="display: none;">Processing...</div>
            <div id="sendResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Validate OTP Form -->
        <div class="form-section">
            <h2>Step 2: Validate OTP</h2>
            <label for="validateAadhar">Aadhar Number:</label>
            <input type="text" id="validateAadhar" placeholder="Enter 12-digit Aadhar Number" maxlength="12">
            <label for="otp">OTP:</label>
            <input type="text" id="otp" placeholder="Enter 6-digit OTP" maxlength="6">
            <button id="validateOtpBtn" onclick="validateOTP()">Validate OTP</button>
            <div id="validateLoading" class="loading" style="display: none;">Processing...</div>
            <div id="validateResponse" class="response" style="display: none;"></div>
        </div>
        
        <div class="troubleshooting-section">
            <h3>Troubleshooting</h3>
            <p>If you're experiencing issues with the KYC verification, try the following:</p>
            <ul>
                <li>Verify that your API credentials are correct in the config.ts file</li>
                <li>Ensure your IP address is whitelisted with the KYC API provider</li>
                <li>Check the server logs for detailed error information</li>
            </ul>
        </div>
    </div>

    <script>
        // Check connection status when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const statusBar = document.getElementById('connection-status');
                const response = await fetch('/api/config-status');
                const data = await response.json();
                
                statusBar.textContent = `Connected to API: ${data.apiUrl} (Partner ID: ${data.partnerId})`;
                statusBar.classList.add('connected');
            } catch (error) {
                const statusBar = document.getElementById('connection-status');
                statusBar.textContent = 'Error connecting to API. Check server logs.';
                statusBar.classList.add('error');
            }
        });
        
        // Validate Aadhar number format (12 digits)
        function isValidAadhar(aadhar) {
            const regex = /^\d{12}$/;
            return regex.test(aadhar);
        }

        // Format error response for better readability
        function formatErrorResponse(error) {
            let output = '';
            
            if (error.error) {
                output += `<div class="error-title">${error.error}</div>`;
            }
            
            if (error.details) {
                output += `<div class="error-details">${error.details}</div>`;
            }
            
            if (error.message) {
                output += `<div class="error-message">${error.message}</div>`;
            }
            
            if (error.possibleSolutions) {
                output += `<div class="error-solutions"><strong>Possible solutions:</strong><ul>`;
                error.possibleSolutions.forEach(solution => {
                    output += `<li>${solution}</li>`;
                });
                output += `</ul></div>`;
            }
            
            return output || JSON.stringify(error, null, 2);
        }

        async function sendOTP() {
            const aadhar = document.getElementById('sendAadhar').value;
            const responseDiv = document.getElementById('sendResponse');
            const loadingDiv = document.getElementById('sendLoading');
            const sendBtn = document.getElementById('sendOtpBtn');
            
            // Validate input
            if (!isValidAadhar(aadhar)) {
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = 'Error: Please enter a valid 12-digit Aadhar number';
                responseDiv.classList.add('error');
                return;
            }

            try {
                // Show loading, disable button
                loadingDiv.style.display = 'block';
                sendBtn.disabled = true;
                responseDiv.style.display = 'none';
                
                const res = await fetch('/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_number: aadhar }),
                });
                
                // Copy Aadhar to validate section for convenience
                document.getElementById('validateAadhar').value = aadhar;
                
                const data = await res.json();
                responseDiv.style.display = 'block';
                
                if (res.ok) {
                    responseDiv.classList.remove('error');
                    responseDiv.innerHTML = `<strong>Response:</strong><br>${JSON.stringify(data, null, 2)}`;
                } else {
                    responseDiv.classList.add('error');
                    responseDiv.innerHTML = formatErrorResponse(data);
                }
            } catch (error) {
                responseDiv.style.display = 'block';
                responseDiv.classList.add('error');
                responseDiv.innerHTML = 'Error: ' + error.message;
            } finally {
                loadingDiv.style.display = 'none';
                sendBtn.disabled = false;
            }
        }

        async function validateOTP() {
            const aadhar = document.getElementById('validateAadhar').value;
            const otp = document.getElementById('otp').value;
            const responseDiv = document.getElementById('validateResponse');
            const loadingDiv = document.getElementById('validateLoading');
            const validateBtn = document.getElementById('validateOtpBtn');
            
            // Validate inputs
            if (!isValidAadhar(aadhar)) {
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = 'Error: Please enter a valid 12-digit Aadhar number';
                return;
            }
            
            if (!otp || otp.length < 4) {
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = 'Error: Please enter a valid OTP';
                return;
            }

            try {
                // Show loading, disable button
                loadingDiv.style.display = 'block';
                validateBtn.disabled = true;
                responseDiv.style.display = 'none';
                
                const res = await fetch('/validate-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_number: aadhar, otp }),
                });
                
                const data = await res.json();
                responseDiv.style.display = 'block';
                
                if (res.ok) {
                    responseDiv.classList.remove('error');
                    responseDiv.innerHTML = `<strong>Response:</strong><br>${JSON.stringify(data, null, 2)}`;
                } else {
                    responseDiv.classList.add('error');
                    responseDiv.innerHTML = formatErrorResponse(data);
                }
            } catch (error) {
                responseDiv.style.display = 'block';
                responseDiv.classList.add('error');
                responseDiv.innerHTML = 'Error: ' + error.message;
            } finally {
                loadingDiv.style.display = 'none';
                validateBtn.disabled = false;
            }
        }

        // Auto-fill validate Aadhar field if send OTP succeeds
        document.getElementById('sendAadhar').addEventListener('input', function() {
            document.getElementById('validateAadhar').value = this.value;
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aadhar KYC Verification</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1>Aadhar KYC Verification</h1>
        <div id="connection-status" class="status-bar">Checking API connection...</div>

        <!-- Simplified One-Click Verification Form -->
        <div class="form-section">
            <h2>One-Click KYC Verification</h2>
            <p>Enter your Aadhar number and click Verify to complete the KYC process.</p>
            
            <label for="aadhar">Aadhar Number:</label>
            <input type="text" id="aadhar" placeholder="Enter 12-digit Aadhar Number" maxlength="12">
            
            <button id="verifyBtn" onclick="verifyAadhar()">Verify KYC</button>
            <div id="loading" class="loading" style="display: none;">Processing verification...</div>
            <div id="response" class="response" style="display: none;"></div>
        </div>
        
        <div class="verification-steps">
            <h3>Verification Process:</h3>
            <ol>
                <li id="step1" class="step">Send verification request</li>
                <li id="step2" class="step">Process verification automatically</li>
                <li id="step3" class="step">Receive KYC verification result</li>
            </ol>
        </div>
        
        <div class="troubleshooting-section">
            <h3>Troubleshooting</h3>
            <p>If you're experiencing issues with the KYC verification, try the following:</p>
            <ul>
                <li>Verify that your API credentials are correct in the config.ts file</li>
                <li>Ensure your IP address is whitelisted with the API provider</li>
                <li><a href="/debug.html" target="_blank">Open Debug Console</a> to view detailed API logs</li>
            </ul>
        </div>
    </div>

    <script>
        // Check connection status when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const statusBar = document.getElementById('connection-status');
                const response = await fetch('/api/config-status');
                const data = await response.json();
                
                statusBar.textContent = `Connected to API: ${data.apiUrl} (Partner ID: ${data.partnerId})`;
                statusBar.classList.add('connected');
            } catch (error) {
                const statusBar = document.getElementById('connection-status');
                statusBar.textContent = 'Error connecting to API. Check server logs.';
                statusBar.classList.add('error');
            }
        });
        
        // Validate Aadhar number format (12 digits)
        function isValidAadhar(aadhar) {
            const regex = /^\d{12}$/;
            return regex.test(aadhar);
        }

        // Format error response for better readability
        function formatErrorResponse(error) {
            let output = '';
            
            if (error.error) {
                output += `<div class="error-title">${error.error}</div>`;
            }
            
            if (error.details) {
                output += `<div class="error-details">${error.details}</div>`;
            }
            
            if (error.message) {
                output += `<div class="error-message">${error.message}</div>`;
            }
            
            return output || JSON.stringify(error, null, 2);
        }
        
        // Mark a step as active, complete, or failed
        function updateStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            step.classList.remove('active', 'complete', 'failed');
            step.classList.add(status);
        }

        async function verifyAadhar() {
            const aadhar = document.getElementById('aadhar').value;
            const responseDiv = document.getElementById('response');
            const loadingDiv = document.getElementById('loading');
            const verifyBtn = document.getElementById('verifyBtn');
            
            // Reset steps
            updateStepStatus('step1', 'pending');
            updateStepStatus('step2', 'pending');
            updateStepStatus('step3', 'pending');
            
            // Validate input
            if (!isValidAadhar(aadhar)) {
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = 'Error: Please enter a valid 12-digit Aadhar number';
                responseDiv.classList.add('error');
                return;
            }

            try {
                // Show loading, disable button
                loadingDiv.style.display = 'block';
                verifyBtn.disabled = true;
                responseDiv.style.display = 'none';
                
                // Step 1: Send verification request
                updateStepStatus('step1', 'active');
                
                // Generate a test OTP value (only for testing purposes)
                const testOtp = "123456"; // This is only used in test environments
                
                // For production, use this line instead:
                // const body = { id_number: aadhar };
                
                // For testing with automatic OTP validation:
                const body = { id_number: aadhar, otp: testOtp };
                
                const res = await fetch('/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                
                updateStepStatus('step1', 'complete');
                updateStepStatus('step2', 'active');
                
                const data = await res.json();
                
                // Step completed
                updateStepStatus('step2', 'complete');
                updateStepStatus('step3', 'active');
                
                responseDiv.style.display = 'block';
                
                if (res.ok) {
                    updateStepStatus('step3', 'complete');
                    responseDiv.classList.remove('error');
                    responseDiv.classList.add('success');
                    
                    // Show verification success message
                    responseDiv.innerHTML = `
                        <div class="success-title">Verification Successful</div>
                        <div class="success-details">Your Aadhar verification was completed successfully.</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    updateStepStatus('step3', 'failed');
                    responseDiv.classList.add('error');
                    responseDiv.innerHTML = formatErrorResponse(data);
                }
            } catch (error) {
                updateStepStatus('step3', 'failed');
                responseDiv.style.display = 'block';
                responseDiv.classList.add('error');
                responseDiv.innerHTML = 'Error: ' + error.message;
            } finally {
                loadingDiv.style.display = 'none';
                verifyBtn.disabled = false;
            }
        }
    </script>
</body>
</html>